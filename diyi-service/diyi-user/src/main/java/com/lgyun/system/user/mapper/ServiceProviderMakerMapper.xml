<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lgyun.system.user.mapper.ServiceProviderMakerMapper">

    <resultMap type="com.lgyun.system.user.vo.RelMakerListVO" id="relEnterpriseMakerVO">
        <result property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="idcardNo" column="idcard_no"/>
        <result property="phoneNumber" column="phone_number"/>
        <result property="bankCardNo" column="bank_card_no"/>
        <result property="boolRealNameVerify" column="bool_real_name_verify"/>
        <result property="boolSign" column="bool_sign"/>
        <result property="boolIndividualBusiness" column="bool_individual_business"/>
        <result property="boolIndividualEnterprise" column="bool_individual_enterprise"/>
    </resultMap>

    <select id="getServiceProviderMakers" resultMap="relEnterpriseMakerVO">
        SELECT DISTINCT t2.id, t2.name, t2.idcard_no, t2.phone_number, t2.bank_card_no,
        IF(t2.bank_card_verify_status = 'VERIFYPASS', TRUE, FALSE) AS bool_real_name_verify,
        IF((SELECT COUNT(id) FROM diyi_agreement WHERE is_deleted = 0 AND maker_id = t2.id AND sign_state = 'SIGNED' AND agreement_type = 1) > 0
        AND (SELECT COUNT(id) FROM diyi_agreement WHERE is_deleted = 0 AND maker_id = t2.id AND sign_state = 'SIGNED' AND agreement_type = 9) > 0, TRUE, FALSE) AS bool_sign,
        IF((SELECT COUNT(id) FROM diyi_individual_business WHERE is_deleted = 0 AND maker_id = t2.id AND ibstate = 'OPERATING') > 0, TRUE, FALSE) AS bool_individual_business,
        IF((SELECT COUNT(id) FROM diyi_individual_enterprise WHERE is_deleted = 0 AND maker_id = t2.id AND ibstate = 'OPERATING') > 0, TRUE, FALSE) AS bool_individual_enterprise
        FROM diyi_service_provider_maker t1 INNER JOIN diyi_maker t2 ON t1.maker_id = t2.id WHERE t1.is_deleted = 0 AND t2.is_deleted = 0 AND t1.service_provider_id = #{param1}
        <if test="param2 != null and param2.trim() != ''">
            AND (t2.id like concat('%', #{param2}, '%')
            OR t2.name like concat('%', #{param2}, '%')
            OR t2.phone_number like concat('%', #{param2}, '%'))
        </if>
    </select>

</mapper>
