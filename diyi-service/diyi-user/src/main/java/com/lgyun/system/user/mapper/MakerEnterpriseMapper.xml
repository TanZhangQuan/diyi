<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lgyun.system.user.mapper.MakerEnterpriseMapper">

    <resultMap type="com.lgyun.system.user.vo.MakerEnterpriseRelationVO" id="makerEnterpriseRelationMap">
        <result property="enterpriseName" column="enterprise_name"/>
        <result property="shopUserName" column="shop_user_name"/>
        <result property="legalPerson" column="legal_person"/>
        <result property="legalPersonCard" column="legal_person_card"/>
        <result property="contact1Position" column="contact1_position"/>
        <result property="contact1Phone" column="contact1_phone"/>
        <result property="socialCreditNo" column="social_credit_no"/>
        <result property="bizLicenceUrl" column="biz_licence_url"/>
        <result property="enterpriseId" column="enterprise_id"/>
        <result property="enterpriseId" column="enterprise_id"/>
        <result property="enterpriseId" column="enterprise_id"/>
    </resultMap>

    <resultMap type="com.lgyun.system.user.vo.RelMakerListVO" id="relEnterpriseMakerVO">
        <result property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="idcardNo" column="idcard_no"/>
        <result property="phoneNumber" column="phone_number"/>
        <result property="bankCardNo" column="bank_card_no"/>
        <result property="boolRealNameVerify" column="bool_real_name_verify"/>
        <result property="boolSign" column="bool_sign"/>
        <result property="boolIndividualBusiness" column="bool_individual_business"/>
        <result property="boolIndividualEnterprise" column="bool_individual_enterprise"/>
    </resultMap>

    <resultMap type="com.lgyun.system.user.vo.EnterprisesIdNameListVO" id="enterprisesIdNameListVO">
        <result property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="idcardNo" column="idcard_no"/>
        <result property="phoneNumber" column="phone_number"/>
        <result property="bankCardNo" column="bank_card_no"/>
        <result property="boolRealNameVerify" column="bool_real_name_verify"/>
        <result property="boolSign" column="bool_sign"/>
        <result property="boolIndividualBusiness" column="bool_individual_business"/>
        <result property="boolIndividualEnterprise" column="bool_individual_enterprise"/>
    </resultMap>

    <resultMap id="makerEnterpriseWebVOMap" type="com.lgyun.system.user.vo.MakerEnterpriseWebVO">
        <result property="enterpriseId" column="enterprise_id"/>
        <result property="name" column="name"/>
        <result property="makerEnterpriseId" column="maker_enterprise_id"/>
        <result property="makerId" column="maker_id"/>
        <result property="certificationState" column="certification_state"/>
        <result property="protocolAuthentication" column="protocol_authentication"/>
        <result property="empowerSignState" column="empower_sign_state"/>
        <result property="joinSignState" column="join_sign_state"/>
    </resultMap>

    <resultMap type="com.lgyun.system.order.vo.SelfHelpInvoiceSerProVO" id="selfHelpInvoiceSerProVO">
        <result property="id" column="id"/>
        <result property="currentState" column="current_state"/>
        <result property="enterpriseName" column="enterprise_name"/>
        <result property="invoiceScanPictures" column="invoice_scan_pictures"/>
        <result property="taxScanPictures" column="tax_scan_pictures"/>
        <result property="createTime" column="create_time"/>
    </resultMap>

    <resultMap type="com.lgyun.system.order.vo.SelfHelpInvoiceDetailProviderVO" id="selfHelpInvoiceDetailProviderVO">
        <result property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="idCardNo" column="id_card_no"/>
        <result property="phoneNumber" column="phone_number"/>
        <result property="bankNo" column="bank_no"/>
    </resultMap>

    <select id="selectMakerEnterprisePage" resultMap="makerEnterpriseRelationMap">
        SELECT e.enterprise_name, e.shop_user_name, e.legal_person, e.legal_person_card, e.contact1_position, e.contact1_phone, e.social_credit_no,
        e.biz_licence_url, e.id as enterprise_id FROM diyi_maker_enterprise me INNER JOIN diyi_enterprise e ON me.enterprise_id = e.id
        WHERE me.is_deleted = 0 and e.is_deleted = 0 and me.maker_id = #{param1} AND me.relationship_type = #{param2} and me.cooperate_status = 'COOPERATING'
    </select>

    <select id="getEnterpriseMakers" resultMap="relEnterpriseMakerVO">
        SELECT t2.id, t2.name, t2.idcard_no, t2.phone_number, t2.bank_card_no,
        IF(t2.bank_card_verify_status = 'VERIFYPASS', TRUE, FALSE) AS bool_real_name_verify,
        IF((SELECT COUNT(id) FROM diyi_agreement WHERE is_deleted = 0 AND maker_id = t2.id AND sign_state = 'SIGNED' AND agreement_type = 1) > 0
        AND (SELECT COUNT(id) FROM diyi_agreement WHERE is_deleted = 0 AND maker_id = t2.id AND sign_state = 'SIGNED' AND agreement_type = 9) > 0, TRUE, FALSE) AS bool_sign,
        IF((SELECT COUNT(id) FROM diyi_individual_business WHERE is_deleted = 0 AND maker_id = t2.id AND ibstate = 'OPERATING') > 0, TRUE, FALSE) AS bool_individual_business,
        IF((SELECT COUNT(id) FROM diyi_individual_enterprise WHERE is_deleted = 0 AND maker_id = t2.id AND ibstate = 'OPERATING') > 0, TRUE, FALSE) AS bool_individual_enterprise
        FROM diyi_maker_enterprise t1 INNER JOIN diyi_maker t2 ON t1.maker_id = t2.id WHERE t1.is_deleted = 0 AND t2.is_deleted = 0 AND t1.enterprise_id = #{param1}
        AND t1.relationship_type = #{param2}
        <if test="param3 != null and param3.trim() != ''">
            AND (t2.id like concat('%', #{param3}, '%')
            OR t2.name like concat('%', #{param3}, '%')
            OR t2.phone_number like concat('%', #{param3}, '%'))
        </if>
    </select>

    <select id="findEnterpriseIdNameByMakerId" resultMap="enterprisesIdNameListVO">
        SELECT t2.id, t2.enterprise_name FROM diyi_maker_enterprise t1 INNER JOIN diyi_enterprise t2 ON t1.enterprise_id = t2.id
        WHERE t1.is_deleted = 0 AND t2.is_deleted = 0 AND t2.enterprise_state = 'NORMAL' AND t1.relationship_type = 'RELEVANCE' AND t1.maker_id = #{param1}
    </select>

    <select id="getSelfHelpInvoiceByServiceProviderId" resultMap="selfHelpInvoiceSerProVO">
        SELECT t1.id, t1.current_state, t3.enterprise_name, t4.invoice_scan_pictures, t4.tax_scan_pictures, t1.create_time FROM diyi_self_help_invoice t1
        INNER JOIN diyi_self_help_invoice_sp t2 ON t1.id = t2.self_help_invoice_id INNER JOIN diyi_enterprise t3 ON t1.enterprise_id = t3.id
        LEFT JOIN diyi_self_help_invoice_sp_detail t4 ON t2.id = t4.self_help_invoice_apply_provider_id AND t4.is_deleted = 0
        WHERE t1.is_deleted = 0 AND t2.is_deleted = 0 AND t3.is_deleted = 0 AND t2.service_provider_id = #{param1}
        <if test="param2 != null and param2.trim() != ''">
            AND t3.enterprise_name like concat('%', #{param2}, '%')
        </if>
    </select>

    <select id="selectEnterpriseMaker" resultMap="makerEnterpriseWebVOMap">
        SELECT e.id AS enterprise_id, m.id AS maker_enterprise_id, k.id AS maker_id, k.certification_state, k.empower_sign_state, k.join_sign_state,
        k. NAME FROM diyi_maker_enterprise m INNER JOIN diyi_enterprise e ON m.enterprise_id = e.id INNER JOIN diyi_maker k ON k.id = m.maker_id
        WHERE m.relationship_type = 'RELEVANCE' AND m.cooperate_status = 'COOPERATING' AND m.is_deleted = 0 AND e.is_deleted = 0 AND k.is_deleted = 0
        AND m.enterprise_id = #{param1}
    </select>

    <select id="getSelfHelpInvoiceDetails" resultMap="selfHelpInvoiceDetailProviderVO">
        SELECT IF(t2.maker_id IS NOT NULL, (SELECT id FROM diyi_maker WHERE id = t2.maker_id), (SELECT id FROM diyi_self_help_invoice_person WHERE id = t2.id)) AS id,
        IF(t2.maker_id IS NOT NULL, (SELECT name FROM diyi_maker WHERE id = t2.maker_id), (SELECT id_card_name FROM diyi_self_help_invoice_person WHERE id = t2.id)) AS name,
        IF(t2.maker_id IS NOT NULL, (SELECT idcard_no FROM diyi_maker WHERE id = t2.maker_id), (SELECT id_card_no FROM diyi_self_help_invoice_person WHERE id = t2.id)) AS id_card_no,
        IF(t2.maker_id IS NOT NULL, (SELECT phone_number FROM diyi_maker WHERE id = t2.maker_id), (SELECT phone_number FROM diyi_self_help_invoice_person WHERE id = t2.id)) AS phone_number,
        IF(t2.maker_id IS NOT NULL, (SELECT bank_card_no FROM diyi_maker WHERE id = t2.maker_id), '') AS bank_no
        FROM diyi_self_help_invoice t1 INNER JOIN diyi_self_help_invoice_detail t2 ON t1.id = t2.self_help_invoice_id WHERE t1.is_deleted = 0 AND t2.is_deleted = 0 AND t1.id = #{param1}
    </select>

</mapper>
