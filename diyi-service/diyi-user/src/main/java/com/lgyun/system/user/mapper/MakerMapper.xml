<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lgyun.system.user.mapper.MakerMapper">

    <resultMap type="com.lgyun.system.user.vo.MakerInfoVO" id="makerInfoVO">
        <result property="avatar" column="avatar"/>
        <result property="name" column="name"/>
        <result property="certificationState" column="certification_state"/>
        <result property="selfDesc" column="self_desc"/>
    </resultMap>

    <resultMap type="com.lgyun.system.user.vo.MakerDetailVO" id="makerDetailVO">
        <result property="relDate" column="rel_date"/>
        <result property="name" column="name"/>
        <result property="avatar" column="avatar"/>
        <result property="certificationState" column="certification_state"/>
        <result property="empowerSignState" column="empower_sign_state"/>
        <result property="joinSignState" column="join_sign_state"/>
        <result property="makerState" column="maker_state"/>
        <result property="politicState" column="politic_state"/>
        <result property="nationality" column="nationality"/>
        <result property="levelofedu" column="levelofedu"/>
        <result property="emailAddress" column="email_address"/>
        <result property="idcardNo" column="idcard_no"/>
        <result property="dueDate" column="due_date"/>
        <result property="phoneNumber" column="phone_number"/>
        <result property="bankCardNo" column="bank_card_no"/>
        <result property="bankName" column="bank_name"/>
        <result property="subBankName" column="sub_bank_name"/>
        <result property="idcardPic" column="idcard_pic"/>
        <result property="idcardPicBack" column="idcard_pic_back"/>
        <result property="selfPic" column="self_pic"/>
        <result property="idcardCopy" column="idcard_copy"/>
        <result property="idcardHand" column="idcard_hand"/>
        <result property="idcardBackHand" column="idcard_back_hand"/>
        <result property="picVerify" column="pic_verify"/>
        <result property="idcardVerifyStatus" column="idcard_verify_status"/>
        <result property="idcardVerifyDate" column="idcard_verify_date"/>
        <result property="faceVerifyStatus" column="face_verify_status"/>
        <result property="faceVerifyDate" column="face_verify_date"/>
        <result property="bankCardVerifyStatus" column="bank_card_verify_status"/>
        <result property="bankCardVerifyDate" column="bank_card_verify_date"/>
        <result property="phoneNumberVerifyStatus" column="phone_number_verify_status"/>
        <result property="phoneNumberVerifyDate" column="phone_number_verify_date"/>
        <result property="idcardVerifyType" column="idcard_verify_type"/>
        <result property="manualVerifyName" column="manual_verify_name"/>
        <result property="manualVerifyDesc" column="manual_verify_desc"/>
        <result property="runAddress" column="run_address"/>
        <result property="houseAddress" column="house_address"/>
        <result property="livingAddress" column="living_address"/>
        <result property="selfDesc" column="self_desc"/>
        <result property="shopUrl" column="shop_url"/>
        <result property="shopUserName" column="shop_user_name"/>
        <result property="applyShortVideo" column="apply_short_video"/>
        <result property="videoAudit" column="video_audit"/>
        <result property="videoAuditDate" column="video_audit_date"/>
        <result property="videoAuditPersonName" column="video_audit_person_name"/>
    </resultMap>

    <resultMap type="com.lgyun.system.user.vo.MakerDetailWebVO" id="makerDetailWebVO">
        <result property="id" column="id"/>
        <result property="avatar" column="avatar"/>
        <result property="name" column="name"/>
        <result property="certificationState" column="certification_state"/>
        <result property="selfDesc" column="self_desc"/>
        <result property="orderNum" column="order_num"/>
        <result property="income" column="income"/>
        <result property="idcardNo" column="idcard_no"/>
        <result property="phoneNumber" column="phone_number"/>
        <result property="bankCardNo" column="bank_card_no"/>
        <result property="subBankName" column="sub_bank_name"/>
        <result property="idcardVerifyStatus" column="idcard_verify_status"/>
        <result property="faceVerifyStatus" column="face_verify_status"/>
        <result property="bankCardVerifyStatus" column="bank_card_verify_status"/>
        <result property="phoneNumberVerifyStatus" column="phone_number_verify_status"/>
        <result property="makerJoinAgreement" column="maker_join_agreement"/>
        <result property="makerPowerAttorney" column="maker_power_attorney"/>
        <result property="createTime" column="create_time"/>
        <result property="makerState" column="maker_state"/>
    </resultMap>

    <resultMap type="com.lgyun.system.user.vo.MakerListIndividualVO" id="makerListIndividualVO">
        <result property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="phoneNumber" column="phone_number"/>
        <result property="idcardNo" column="idcard_no"/>
        <result property="idcardPic" column="idcard_pic"/>
        <result property="idcardPicBack" column="idcard_pic_back"/>
        <result property="idcardHand" column="idcard_hand"/>
        <result property="idcardBackHand" column="idcard_back_hand"/>
    </resultMap>

    <resultMap type="com.lgyun.system.user.vo.MakerListWebVO" id="makerListWebVO">
        <result property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="idcardNo" column="idcard_no"/>
        <result property="phoneNumber" column="phone_number"/>
        <result property="bankCardNo" column="bank_card_no"/>
        <result property="idcardVerifyStatus" column="idcard_verify_status"/>
        <result property="faceVerifyStatus" column="face_verify_status"/>
        <result property="bankCardVerifyStatus" column="bank_card_verify_status"/>
        <result property="phoneNumberVerifyStatus" column="phone_number_verify_status"/>
        <result property="empowerSignState" column="empower_sign_state"/>
        <result property="joinSignState" column="join_sign_state"/>
        <result property="createTime" column="create_time"/>
    </resultMap>

    <resultMap type="com.lgyun.system.user.vo.MakerWorkSheetListVO" id="makerWorkSheetListVO">
        <result property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="idcardNo" column="idcard_no"/>
        <result property="phoneNumber" column="phone_number"/>
        <result property="idcardVerifyStatus" column="idcard_verify_status"/>
        <result property="faceVerifyStatus" column="face_verify_status"/>
        <result property="bankCardVerifyStatus" column="bank_card_verify_status"/>
        <result property="phoneNumberVerifyStatus" column="phone_number_verify_status"/>
        <result property="empowerSignState" column="empower_sign_state"/>
        <result property="joinSignState" column="join_sign_state"/>
        <result property="videoAudit" column="video_audit"/>
        <result property="boolSupplementSign" column="bool_supplement_sign"/>
    </resultMap>

    <select id="queryMakerInfo" resultMap="makerInfoVO">
        SELECT avatar, name, certification_state, self_desc FROM diyi_maker WHERE is_deleted = 0 AND id = #{param1}
    </select>

    <select id="queryCurrentMakerDetail" resultMap="makerDetailVO">
        SELECT rel_date, name, avatar, certification_state, empower_sign_state, join_sign_state, maker_state, politic_state, nationality, levelofedu,
        email_address, idcard_no, due_date, phone_number, bank_card_no, bank_name, sub_bank_name, idcard_pic, idcard_pic_back,
        self_pic, idcard_copy, idcard_hand, idcard_back_hand, pic_verify, idcard_verify_status, idcard_verify_date, face_verify_status, face_verify_date,
        bank_card_verify_status, bank_card_verify_date, phone_number_verify_status, phone_number_verify_date, idcard_verify_type, manual_verify_name,
        manual_verify_desc, run_address, house_address, living_address, self_desc, shop_url, shop_user_name, apply_short_video, video_audit,
        video_audit_date, (SELECT t1.name FROM diyi_admin t1 WHERE t1.is_deleted = 0 AND t1.id = video_audit_person_id) AS video_audit_person_name FROM diyi_maker
        WHERE is_deleted = 0 AND id = #{param1}
    </select>

    <select id="queryMakerDetail" resultMap="makerDetailWebVO">
        SELECT t5.id, t5.avatar, t5.name, t5.certification_state, t5.self_desc, t5.idcard_no, t5.phone_number, t5.bank_card_no, t5.sub_bank_name, t5.idcard_verify_status,
        t5.face_verify_status, t5.bank_card_verify_status, t5.phone_number_verify_status, t5.create_time, t5.maker_state, ((SELECT COUNT(id) FROM diyi_pay_maker t1
        WHERE is_deleted = 0 AND (pay_state = 'PLATFORMPAID' OR pay_state = 'CONFIRMPAID') AND maker_id = t5.id) + (SELECT COUNT(id) FROM diyi_self_help_invoice_detail
        WHERE is_deleted = 0 AND (invoice_print_state = 'INVOICEING' OR invoice_print_state = 'INVOICESUCCESS') AND maker_id = t5.id)) AS order_num,
        ((SELECT IFNULL(SUM(maker_net_income), 0) FROM diyi_pay_maker t1 WHERE is_deleted = 0 AND (pay_state = 'PLATFORMPAID' OR pay_state = 'CONFIRMPAID')
        AND maker_id = t5.id) + (SELECT IFNULL(SUM(charge_money_num), 0) FROM diyi_self_help_invoice_detail WHERE is_deleted = 0 AND (invoice_print_state = 'INVOICEING'
        OR invoice_print_state = 'INVOICESUCCESS') AND maker_id = t5.id)) AS income, (SELECT IF(paper_agreement_url IS NOT NULL AND paper_agreement_url <![CDATA[ <> ]]> '',
        paper_agreement_url, online_agreement_url) FROM diyi_agreement WHERE is_deleted = 0 AND maker_id = t5.id AND sign_state = 'SIGNED' AND audit_state = 'APPROVED'
        AND agreement_type = 'MAKERJOINAGREEMENT') AS maker_join_agreement, (SELECT IF(paper_agreement_url IS NOT NULL AND paper_agreement_url <![CDATA[ <> ]]> '', paper_agreement_url,
        online_agreement_url) FROM diyi_agreement WHERE is_deleted = 0 AND maker_id = t5.id AND sign_state = 'SIGNED' AND audit_state = 'APPROVED'
        AND agreement_type = 'MAKERPOWERATTORNEY') AS maker_power_attorney FROM diyi_maker t5 WHERE t5.is_deleted = 0 AND t5.id = #{param1}
    </select>

    <select id="queryMakerListIndividual" resultMap="makerListIndividualVO">
        SELECT t1.id, t1.name, t1.phone_number, t1.idcard_no, t1.idcard_pic, t1.idcard_pic_back, t1.idcard_hand, t1.idcard_back_hand FROM diyi_maker t1
        <if test="param1 != null">
        INNER JOIN diyi_maker_enterprise t2 ON t1.id = t2.maker_id AND t2.relationship_type = 'RELEVANCE' AND t2.is_deleted = 0
        </if>
        WHERE t1.is_deleted = 0 AND t1.phone_number_verify_status = 'VERIFYPASS'
        <if test="param1 != null">
        AND t2.enterprise_id = #{param1}
        </if>
        <if test="param2.name != null and param2.name.trim() != ''">
            AND t1.name LIKE concat('%', #{param2.name}, '%')
        </if>
        <if test="param2.phoneNumber != null and param2.phoneNumber.trim() != ''">
            AND t1.phone_number LIKE concat('%', #{param2.phoneNumber}, '%')
        </if>
        <if test="param2.idcardNo != null and param2.idcardNo.trim() != ''">
            AND t1.idcard_no LIKE concat('%', #{param2.idcardNo}, '%')
        </if>
    </select>

    <select id="queryMakerList" resultMap="makerListWebVO">
        SELECT
        <if test="param2 != null">
            DISTINCT
        </if>
        t1.id, t1.name, t1.idcard_no, t1.phone_number, t1.bank_card_no, t1.idcard_verify_status, t1.face_verify_status, t1.bank_card_verify_status,
        t1.phone_number_verify_status, t1.empower_sign_state, t1.join_sign_state, t1.create_time FROM diyi_maker t1
        <if test="param1 != null">
            INNER JOIN diyi_maker_enterprise t2 ON t1.id = t2.maker_id AND t2.is_deleted = 0
        </if>
        <if test="param2 != null">
            INNER JOIN diyi_service_provider_maker t3 ON t1.id = t3.maker_id AND t3.is_deleted = 0
        </if>
        WHERE t1.is_deleted = 0
        <if test="param1 != null">
            AND t2.enterprise_id = #{param1}
        </if>
        <if test="param2 != null">
            AND t3.service_provider_id = #{param2}
        </if>
        <if test="param3 != null">
            AND t2.relationship_type = #{param3}
        </if>
        <if test="param4 != null">
            AND t1.certification_state = #{param4}
        </if>
        <if test="param5 != null and param5.trim() != ''">
            AND (t1.idcard_no LIKE concat('%', #{param5}, '%')
            OR t1.name LIKE concat('%', #{param5}, '%')
            OR t1.phone_number LIKE concat('%', #{param5}, '%'))
        </if>
    </select>

    <select id="queryWorkMakerList" resultMap="makerWorkSheetListVO">
        SELECT t1.id, t1.name, t1.idcard_no, t1.phone_number, t1.idcard_verify_status, t1.face_verify_status, t1.bank_card_verify_status, t1.phone_number_verify_status,
        t1.empower_sign_state, t1.join_sign_state, t1.video_audit, IF ((SELECT COUNT(id) FROM diyi_agreement WHERE is_deleted = 0 AND maker_id = t1.id
        AND sign_state = 'SIGNED' AND agreement_type = 'ENTMAKSUPPLEMENTARYAGREEMENT' AND enterprise_id = #{param1}) > 0, TRUE, FALSE) AS bool_supplement_sign
        FROM diyi_maker t1 where t1.is_deleted = 0
        <if test="param2 != null and param2.trim() != ''">
            and t1.name LIKE concat('%', #{param2}, '%')
        </if>
    </select>

</mapper>
