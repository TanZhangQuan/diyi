<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lgyun.system.user.mapper.MakerMapper">

    <resultMap type="com.lgyun.system.user.vo.BaseInfoVO" id="makerInfoVO">
        <result property="avatar" column="avatar"/>
        <result property="name" column="name"/>
        <result property="certificationState" column="certification_state"/>
        <result property="selfDesc" column="self_desc"/>
    </resultMap>

    <resultMap type="com.lgyun.system.user.vo.MakerToExamineListVO" id="makerToExamineListVO">
        <result property="makerId" column="maker_id"/>
        <result property="signPicId" column="sign_pic_id"/>
        <result property="makerName" column="maker_name"/>
        <result property="auditState" column="audit_state"/>
        <result property="createTime" column="create_time"/>
        <result property="signPic" column="sign_pic"/>
    </resultMap>

    <resultMap type="com.lgyun.system.user.vo.MakerDetailVO" id="makerDetailVO">
        <result property="relDate" column="rel_date"/>
        <result property="name" column="name"/>
        <result property="avatar" column="avatar"/>
        <result property="certificationState" column="certification_state"/>
        <result property="boolPowerAttorney" column="bool_power_attorney"/>
        <result property="boolJoinAgreement" column="bool_join_agreement"/>
        <result property="makerState" column="maker_state"/>
        <result property="politicState" column="politic_state"/>
        <result property="nationality" column="nationality"/>
        <result property="levelofedu" column="levelofedu"/>
        <result property="emailAddress" column="email_address"/>
        <result property="idcardNo" column="idcard_no"/>
        <result property="dueDate" column="due_date"/>
        <result property="phoneNumber" column="phone_number"/>
        <result property="bankCardNo" column="bank_card_no"/>
        <result property="bankName" column="bank_name"/>
        <result property="subBankName" column="sub_bank_name"/>
        <result property="idcardPic" column="idcard_pic"/>
        <result property="idcardPicBack" column="idcard_pic_back"/>
        <result property="selfPic" column="self_pic"/>
        <result property="idcardCopy" column="idcard_copy"/>
        <result property="idcardHand" column="idcard_hand"/>
        <result property="idcardBackHand" column="idcard_back_hand"/>
        <result property="picVerify" column="pic_verify"/>
        <result property="idcardVerifyStatus" column="idcard_verify_status"/>
        <result property="idcardVerifyDate" column="idcard_verify_date"/>
        <result property="faceVerifyStatus" column="face_verify_status"/>
        <result property="faceVerifyDate" column="face_verify_date"/>
        <result property="bankCardVerifyStatus" column="bank_card_verify_status"/>
        <result property="bankCardVerifyDate" column="bank_card_verify_date"/>
        <result property="phoneNumberVerifyStatus" column="phone_number_verify_status"/>
        <result property="phoneNumberVerifyDate" column="phone_number_verify_date"/>
        <result property="idcardVerifyType" column="idcard_verify_type"/>
        <result property="manualVerifyName" column="manual_verify_name"/>
        <result property="manualVerifyDesc" column="manual_verify_desc"/>
        <result property="runAddress" column="run_address"/>
        <result property="houseAddress" column="house_address"/>
        <result property="livingAddress" column="living_address"/>
        <result property="selfDesc" column="self_desc"/>
        <result property="shopUrl" column="shop_url"/>
        <result property="shopUserName" column="shop_user_name"/>
        <result property="applyShortVideo" column="apply_short_video"/>
        <result property="videoAudit" column="video_audit"/>
        <result property="videoAuditDate" column="video_audit_date"/>
        <result property="videoAuditPersonName" column="video_audit_person_name"/>
    </resultMap>

    <resultMap type="com.lgyun.system.user.vo.MakerDetailWebVO" id="makerDetailWebVO">
        <result property="id" column="id"/>
        <result property="avatar" column="avatar"/>
        <result property="name" column="name"/>
        <result property="certificationState" column="certification_state"/>
        <result property="selfDesc" column="self_desc"/>
        <result property="orderNum" column="order_num"/>
        <result property="income" column="income"/>
        <result property="idcardNo" column="idcard_no"/>
        <result property="phoneNumber" column="phone_number"/>
        <result property="bankCardNo" column="bank_card_no"/>
        <result property="subBankName" column="sub_bank_name"/>
        <result property="idcardVerifyStatus" column="idcard_verify_status"/>
        <result property="idcardPic" column="idcard_pic"/>
        <result property="idcardPicBack" column="idcard_pic_back"/>
        <result property="faceVerifyStatus" column="face_verify_status"/>
        <result property="bankCardVerifyStatus" column="bank_card_verify_status"/>
        <result property="phoneNumberVerifyStatus" column="phone_number_verify_status"/>
        <result property="makerJoinAgreement" column="maker_join_agreement"/>
        <result property="makerPowerAttorney" column="maker_power_attorney"/>
        <result property="createTime" column="create_time"/>
        <result property="makerState" column="maker_state"/>
    </resultMap>

    <resultMap type="com.lgyun.system.user.vo.MakerListIndividualVO" id="makerListIndividualVO">
        <result property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="phoneNumber" column="phone_number"/>
        <result property="idcardNo" column="idcard_no"/>
        <result property="idcardPic" column="idcard_pic"/>
        <result property="idcardPicBack" column="idcard_pic_back"/>
        <result property="idcardHand" column="idcard_hand"/>
        <result property="idcardBackHand" column="idcard_back_hand"/>
    </resultMap>

    <resultMap type="com.lgyun.system.user.vo.MakerListWebVO" id="makerListWebVO">
        <result property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="idcardNo" column="idcard_no"/>
        <result property="phoneNumber" column="phone_number"/>
        <result property="bankCardNo" column="bank_card_no"/>
        <result property="idcardVerifyStatus" column="idcard_verify_status"/>
        <result property="faceVerifyStatus" column="face_verify_status"/>
        <result property="bankCardVerifyStatus" column="bank_card_verify_status"/>
        <result property="phoneNumberVerifyStatus" column="phone_number_verify_status"/>
        <result property="boolPowerAttorney" column="bool_power_attorney"/>
        <result property="boolJoinAgreement" column="bool_join_agreement"/>
        <result property="authorizationAudit" column="authorization_audit"/>
        <result property="signPic" column="sign_pic"/>
        <result property="auditState" column="audit_state"/>
        <result property="createTime" column="create_time"/>
    </resultMap>

    <resultMap type="com.lgyun.system.user.vo.MakerWorkSheetListVO" id="makerWorkSheetListVO">
        <result property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="idcardNo" column="idcard_no"/>
        <result property="phoneNumber" column="phone_number"/>
        <result property="idcardVerifyStatus" column="idcard_verify_status"/>
        <result property="faceVerifyStatus" column="face_verify_status"/>
        <result property="bankCardVerifyStatus" column="bank_card_verify_status"/>
        <result property="phoneNumberVerifyStatus" column="phone_number_verify_status"/>
       <result property="boolPowerAttorney" column="bool_power_attorney"/>
        <result property="boolJoinAgreement" column="bool_join_agreement"/>
        <result property="videoAudit" column="video_audit"/>
        <result property="authorizationAudit" column="authorization_audit"/>
        <result property="boolSupplementSign" column="bool_supplement_sign"/>
    </resultMap>

    <resultMap type="com.lgyun.system.user.vo.MakerSelectListVO" id="makerSelectListVO">
        <result property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="phoneNumber" column="phone_number"/>
        <result property="idcardNo" column="idcard_no"/>
    </resultMap>

    <select id="queryMakerInfo" resultMap="makerInfoVO">
        SELECT avatar, name, certification_state, self_desc FROM diyi_maker WHERE bool_deleted = 0 AND id = #{param1}
    </select>

    <select id="queryCurrentMakerDetail" resultMap="makerDetailVO">
        SELECT t1.rel_date, t1.name, t1.avatar, t1.certification_state, t1.maker_state, t1.politic_state, t1.nationality, t1.levelofedu,
        t1.email_address, t1.idcard_no, t1.due_date, t1.phone_number, t1.bank_card_no, t1.bank_name, t1.sub_bank_name, t1.idcard_pic, t1.idcard_pic_back,
        t1.self_pic, t1.idcard_copy, t1.idcard_hand, t1.idcard_back_hand, t1.pic_verify, t1.idcard_verify_status, t1.idcard_verify_date, t1.face_verify_status,
        t1.face_verify_date, t1.bank_card_verify_status, t1.bank_card_verify_date, t1.phone_number_verify_status, t1.phone_number_verify_date, t1.idcard_verify_type,
        t1.manual_verify_desc, t1.run_address, t1.house_address, t1.living_address, t1.self_desc, t1.shop_url, t1.shop_user_name, t1.apply_short_video, t1.video_audit,
        t1.video_audit_date, (SELECT t2.name FROM diyi_admin t2 WHERE t2.bool_deleted = 0 AND t2.id = t1.manual_verify_id) AS manual_verify_name,
        (SELECT t3.name FROM diyi_admin t3 WHERE t3.bool_deleted = 0 AND t3.id = t1.video_audit_person_id) AS video_audit_person_name,
        IF((SELECT COUNT(id) FROM diyi_agreement WHERE agreement_type = 'MAKERPOWERATTORNEY' AND valid_state = 'VALIDING' AND party_b = 'MAKERPEOPLE'
        AND party_b_id = t1.id) > 0, TRUE, FALSE) AS bool_power_attorney, IF((SELECT COUNT(id) FROM diyi_agreement WHERE agreement_type = 'MAKERJOINAGREEMENT'
        AND valid_state = 'VALIDING' AND party_b = 'MAKERPEOPLE' AND party_b_id = t1.id) > 0, TRUE, FALSE) AS bool_join_agreement FROM diyi_maker t1
        WHERE t1.bool_deleted = 0 AND t1.id = #{param1}
    </select>

    <select id="queryMakerDetail" resultMap="makerDetailWebVO">
        SELECT t5.id, t5.avatar, t5.name, t5.certification_state, t5.self_desc, t5.idcard_no, t5.phone_number, t5.bank_card_no, t5.sub_bank_name, t5.idcard_verify_status,
        t5.idcard_pic, t5.idcard_pic_back, t5.face_verify_status, t5.bank_card_verify_status, t5.phone_number_verify_status, t5.create_time, t5.maker_state, ((SELECT COUNT(id) FROM diyi_pay_maker t1
        WHERE bool_deleted = 0 AND (pay_state = 'PLATFORMPAID' OR pay_state = 'CONFIRMPAID') AND maker_id = t5.id) + (SELECT COUNT(id) FROM diyi_self_help_invoice_detail
        WHERE bool_deleted = 0 AND (invoice_print_state = 'INVOICEING' OR invoice_print_state = 'INVOICESUCCESS') AND maker_id = t5.id)) AS order_num,
        ((SELECT IFNULL(SUM(maker_net_income), 0) FROM diyi_pay_maker t1 WHERE bool_deleted = 0 AND (pay_state = 'PLATFORMPAID' OR pay_state = 'CONFIRMPAID')
        AND maker_id = t5.id) + (SELECT IFNULL(SUM(charge_money_num), 0) FROM diyi_self_help_invoice_detail WHERE bool_deleted = 0 AND (invoice_print_state = 'INVOICEING'
        OR invoice_print_state = 'INVOICESUCCESS') AND maker_id = t5.id)) AS income, (SELECT GROUP_CONCAT(agreement_url) FROM diyi_agreement WHERE bool_deleted = 0
        AND agreement_type = 'MAKERJOINAGREEMENT' AND valid_state = 'VALIDING' AND party_b = 'MAKERPEOPLE' AND party_b_id = t5.id) AS maker_join_agreement,
        (SELECT GROUP_CONCAT(agreement_url) FROM diyi_agreement WHERE bool_deleted = 0 AND agreement_type = 'MAKERPOWERATTORNEY' AND valid_state = 'VALIDING' AND party_b = 'MAKERPEOPLE'
        AND party_b_id = t5.id) AS maker_power_attorney FROM diyi_maker t5 WHERE t5.bool_deleted = 0 AND t5.id = #{param1}
    </select>

    <select id="queryMakerListIndividual" resultMap="makerListIndividualVO">
        SELECT t1.id, t1.name, t1.phone_number, t1.idcard_no, t1.idcard_pic, t1.idcard_pic_back, t1.idcard_hand, t1.idcard_back_hand FROM diyi_maker t1
        <if test="param1 != null">
            INNER JOIN diyi_maker_enterprise t2 ON t1.id = t2.maker_id AND t2.relationship_type = 'RELEVANCE' AND t2.bool_deleted = 0
        </if>
		<if test="param2 != null">
            INNER JOIN diyi_maker_enterprise t3 ON t1.id = t3.maker_id AND t3.relationship_type = 'RELEVANCE' AND t3.bool_deleted = 0
		    INNER JOIN diyi_partner_enterprise t4 ON t3.enterprise_id = t4.enterprise_id AND t4.cooperate_status = 'COOPERATING' AND t4.bool_deleted = 0
        </if>
        WHERE t1.bool_deleted = 0 AND t1.phone_number_verify_status = 'VERIFYPASS'
        <if test="param1 != null">
            AND t2.enterprise_id = #{param1}
        </if>
		<if test="param2 != null">
            AND t4.partner_id = #{param2}
        </if>
        <if test="param3.name != null and param3.name.trim() != ''">
            AND t1.name LIKE concat('%', #{param3.name}, '%')
        </if>
        <if test="param3.phoneNumber != null and param3.phoneNumber.trim() != ''">
            AND t1.phone_number LIKE concat('%', #{param3.phoneNumber}, '%')
        </if>
        <if test="param3.idcardNo != null and param3.idcardNo.trim() != ''">
            AND t1.idcard_no LIKE concat('%', #{param3.idcardNo}, '%')
        </if>
        GROUP BY t1.id
    </select>

    <select id="queryMakerList" resultMap="makerListWebVO">
        SELECT DISTINCT t1.id, t1.name, t1.idcard_no,t1.authorization_audit,p.sign_pic,p.audit_state, t1.phone_number, t1.bank_card_no, t1.idcard_verify_status, t1.face_verify_status, t1.bank_card_verify_status,
        t1.phone_number_verify_status, t1.create_time, IF((SELECT COUNT(id) FROM diyi_agreement WHERE agreement_type = 'MAKERPOWERATTORNEY' AND valid_state = 'VALIDING'
        AND party_b = 'MAKERPEOPLE' AND party_b_id = t1.id) > 0, TRUE, FALSE) AS bool_power_attorney, IF((SELECT COUNT(id) FROM diyi_agreement
        WHERE agreement_type = 'MAKERJOINAGREEMENT' AND valid_state = 'VALIDING' AND party_b = 'MAKERPEOPLE' AND party_b_id = t1.id) > 0, TRUE, FALSE) AS bool_join_agreement
        FROM diyi_maker t1 LEFT JOIN diyi_online_sign_pic p on p.object_id = t1.id and p.object_type = 'MAKERPEOPLE'
        <if test="param1 != null">
            INNER JOIN diyi_maker_enterprise t2 ON t1.id = t2.maker_id AND t2.bool_deleted = 0 AND t2.enterprise_id = #{param1}
            <if test="param4 != null">
                AND t2.relationship_type = #{param4}
            </if>
        </if>
        <if test="param2 != null">
            INNER JOIN diyi_service_provider_maker t3 ON t1.id = t3.maker_id AND t3.bool_deleted = 0 AND t3.service_provider_id = #{param2}
        </if>
        <if test="param3 != null">
            INNER JOIN diyi_service_provider_maker t4 ON t1.id = t4.maker_id AND t4.bool_deleted = 0 INNER JOIN diyi_rel_bureau_service_provider t5
            ON t4.service_provider_id = t5.service_provider_id AND t5.bool_deleted = 0 AND t5.rel_bureau_id = #{param3}
        </if>
        WHERE t1.bool_deleted = 0
        <if test="param5 != null">
            AND t1.certification_state = #{param5}
        </if>
        <if test="param6 != null and param6.trim() != ''">
            AND (t1.idcard_no LIKE concat('%', #{param6}, '%')
            OR t1.name LIKE concat('%', #{param6}, '%')
            OR t1.phone_number LIKE concat('%', #{param6}, '%'))
        </if>
    </select>

<!--    <select id="queryWorkMakerList" resultMap="makerWorkSheetListVO">-->
<!--        SELECT t1.id, t1.name, t1.idcard_no, t1.phone_number,t1.authorization_audit, t1.idcard_verify_status, t1.face_verify_status, t1.bank_card_verify_status, t1.phone_number_verify_status,-->
<!--        t1.video_audit, IF((SELECT COUNT(id) FROM diyi_agreement WHERE bool_deleted = 0 AND agreement_type = 'ENTMAKSUPPLEMENTARYAGREEMENT' AND valid_state = 'VALIDING'-->
<!--        AND party_a = 'ENTERPRISEPEOPLE' AND party_a_id = t2.enterprise_id AND party_b = 'MAKERPEOPLE' AND party_b_id = t1.id) > 0, TRUE, FALSE) AS bool_supplement_sign,-->
<!--        IF((SELECT COUNT(id) FROM diyi_agreement WHERE agreement_type = 'MAKERPOWERATTORNEY' AND valid_state = 'VALIDING' AND party_b = 'MAKERPEOPLE'-->
<!--        AND party_b_id = t1.id) > 0, TRUE, FALSE) AS bool_power_attorney, IF((SELECT COUNT(id) FROM diyi_agreement WHERE agreement_type = 'MAKERJOINAGREEMENT'-->
<!--        AND valid_state = 'VALIDING' AND party_b = 'MAKERPEOPLE' AND party_b_id = t1.id) > 0, TRUE, FALSE) AS bool_join_agreement-->
<!--        FROM diyi_maker t1 INNER JOIN diyi_maker_enterprise t2 ON t2.maker_id = t1.id where t1.bool_deleted = 0 and t2.bool_deleted = 0 and t2.enterprise_id = #{param1}-->
<!--        <if test="param2 != null and param2.trim() != ''">-->
<!--            and t1.name LIKE concat('%', #{param2}, '%')-->
<!--        </if>-->
<!--    </select>-->

    <select id="queryWorkMakerList" resultMap="makerWorkSheetListVO">
        SELECT DISTINCT tmp.id, tmp. name, tmp.idcard_no,tmp.authorization_audit, tmp.phone_number, tmp.idcard_verify_status, tmp.face_verify_status, tmp.bank_card_verify_status, tmp.phone_number_verify_status, tmp.video_audit, tmp.bool_supplement_sign, tmp.bool_power_attorney, tmp.bool_join_agreement
        FROM ( SELECT t1.id,t1.authorization_audit, t1.NAME, t1.idcard_no, t1.phone_number, t1.idcard_verify_status, t1.face_verify_status, t1.bank_card_verify_status, t1.phone_number_verify_status, t1.video_audit, IF (( SELECT COUNT(id) FROM diyi_agreement WHERE bool_deleted = 0 AND agreement_type = 'ENTMAKSUPPLEMENTARYAGREEMENT' AND valid_state = 'VALIDING' AND party_a = 'ENTERPRISEPEOPLE' AND party_a_id = t2.enterprise_id AND party_b = 'MAKERPEOPLE' AND party_b_id = t1.id ) > 0, TRUE, FALSE ) AS bool_supplement_sign, IF (( SELECT COUNT(id) FROM diyi_agreement WHERE agreement_type = 'MAKERPOWERATTORNEY' AND valid_state = 'VALIDING' AND party_b = 'MAKERPEOPLE' AND party_b_id = t1.id ) > 0, TRUE, FALSE ) AS bool_power_attorney, IF (( SELECT COUNT(id) FROM diyi_agreement WHERE agreement_type = 'MAKERJOINAGREEMENT' AND valid_state = 'VALIDING' AND party_b = 'MAKERPEOPLE' AND party_b_id = t1.id ) > 0, TRUE, FALSE ) AS bool_join_agreement FROM diyi_maker t1 INNER JOIN diyi_maker_enterprise t2 ON t2.maker_id = t1.id WHERE t1.bool_deleted = 0 AND t2.bool_deleted = 0 AND t2.enterprise_id = #{param1}
        UNION ALL SELECT t1.id, t1.authorization_audit,t1. NAME, t1.idcard_no, t1.phone_number, t1.idcard_verify_status, t1.face_verify_status, t1.bank_card_verify_status, t1.phone_number_verify_status, t1.video_audit, 0 AS bool_supplement_sign, IF (( SELECT COUNT(id) FROM diyi_agreement WHERE agreement_type = 'MAKERPOWERATTORNEY' AND valid_state = 'VALIDING' AND party_b = 'MAKERPEOPLE' AND party_b_id = t1.id ) > 0, TRUE, FALSE ) AS bool_power_attorney, IF (( SELECT COUNT(id) FROM diyi_agreement WHERE agreement_type = 'MAKERJOINAGREEMENT' AND valid_state = 'VALIDING' AND party_b = 'MAKERPEOPLE' AND party_b_id = t1.id ) > 0, TRUE, FALSE ) AS bool_join_agreement FROM diyi_maker t1 WHERE t1.bool_deleted = 0 AND t1.authorization_audit = 'AUTHORIZED' ) tmp WHERE 1 = 1
        <if test="param2 != null and param2.trim() != ''">
            and tmp.name LIKE concat('%', #{param2}, '%')
        </if>
         GROUP BY tmp.id
    </select>

    <select id="queryMakerSelectList" resultMap="makerSelectListVO">
        SELECT id, name, phone_number, idcard_no FROM diyi_maker WHERE bool_deleted = 0
        <if test="param1 != null and param1.trim() != ''">
            AND (idcard_no LIKE concat('%', #{param1}, '%')
            OR name LIKE concat('%', #{param1}, '%')
            OR phone_number LIKE concat('%', #{param1}, '%'))
        </if>
    </select>

    <select id="queryMakerToExamineList" resultMap="makerToExamineListVO">
        SELECT s1.id AS maker_id, s1. NAME AS maker_name, s2.audit_state, s2.create_time, s2.sign_pic, s2.id AS sign_pic_id FROM diyi_maker s1 INNER JOIN diyi_online_sign_pic s2 ON s2.object_id = s1.id AND s2.object_type = 'MAKERPEOPLE' WHERE s1.authorization_audit = 'UNAUTHORIZED' AND s2.audit_state = 'EDITING'
        <if test="param1 != null and param1.trim() != ''">
            and t1.name LIKE concat('%', #{param1}, '%')
        </if>
    </select>

</mapper>
