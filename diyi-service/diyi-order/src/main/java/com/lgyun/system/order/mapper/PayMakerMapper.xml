<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lgyun.system.order.mapper.PayMakerMapper">

    <resultMap type="com.lgyun.system.order.vo.PayEnterpriseMakersListVO" id="payEnterpriseMakersListVO">
        <result property="id" column="id"/>
        <result property="payEnterpriseId" column="pay_enterprise_id"/>
        <result property="enterpriseName" column="enterprise_name"/>
        <result property="serviceProviderName" column="service_provider_name"/>
        <result property="chargeListUrl" column="charge_list_url"/>
        <result property="enterprisePayReceiptUrls" column="enterprise_pay_receipt_urls"/>
        <result property="worksheetNo" column="worksheet_no"/>
        <result property="acceptPaysheetUrls" column="accept_paysheet_urls"/>
        <result property="makerPayReceiptUrls" column="maker_pay_receipt_urls"/>
        <result property="auditState" column="audit_state"/>
        <result property="createTime" column="create_time"/>
        <result property="payToPlatformAmount" column="pay_to_platform_amount"/>
    </resultMap>

    <select id="getPayMakersByEnterprise" resultMap="payEnterpriseMakersListVO">
        SELECT t5.id, t1.id AS pay_enterprise_id, t2.enterprise_name, t3.service_provider_name, t1.charge_list_url, t4.worksheet_no, t1.create_time, t1.pay_to_platform_amount,
        (SELECT GROUP_CONCAT(enterprise_pay_receipt_url) FROM diyi_pay_enterprise_receipt WHERE is_deleted = 0 AND pay_enterprise_id = t1.id) AS enterprise_pay_receipt_urls,
        (SELECT GROUP_CONCAT(accept_paysheet_url) FROM diyi_accept_paysheet WHERE is_deleted = 0 AND pay_enterprise_id = t1.id) AS accept_paysheet_urls,
        (SELECT GROUP_CONCAT(maker_pay_receipt_url) FROM diyi_pay_maker_receipt WHERE is_deleted = 0 AND pay_maker_id = t5.id) AS maker_pay_receipt_urls FROM diyi_pay_enterprise t1
        INNER JOIN diyi_enterprise t2 ON t1.enterprise_id = t2.id INNER JOIN diyi_service_provider t3 ON t1.service_provider_id = t3.id
        LEFT JOIN diyi_worksheet t4 ON t1.worksheet_id = t4.id AND t4.is_deleted = 0 INNER JOIN diyi_pay_maker t5 ON t1.id = t5.pay_enterprise_id
        WHERE t1.is_deleted = 0 AND t2.is_deleted = 0 AND t3.is_deleted = 0 AND t5.is_deleted =0
        <if test="param1 != null">
            AND t1.enterprise_id = #{param1}
        </if>
        <if test="param2 != null">
            AND t1.service_provider_id = #{param2}
            AND t1.pay_state <![CDATA[ <> ]]> 'TOPAY'
            AND t1.audit_state <![CDATA[ <> ]]> 'EDITING'
        </if>
        <if test="param3.payEnterpriseMakerId != null">
            AND t5.id = #{param3.payEnterpriseMakerId}
        </if>
        <if test="param3.serviceProviderName != null and param3.serviceProviderName.trim() != ''">
            AND t3.service_provider_name like concat('%', #{param3.serviceProviderName}, '%')
        </if>
        <if test="param3.enterpriseName != null and param3.enterpriseName.trim() != ''">
            AND t2.enterprise_name like concat('%', #{param3.enterpriseName}, '%')
        </if>
        <if test="param3.beginDate != null">
            AND DATEDIFF(t1.create_time, #{param3.beginDate}) <![CDATA[ >= ]]> 0
        </if>
        <if test="param3.endDate != null">
            AND DATEDIFF(t1.create_time, #{param3.endDate}) <![CDATA[ <= ]]> 0
        </if>
    </select>

</mapper>
