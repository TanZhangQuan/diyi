<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lgyun.system.order.mapper.PayEnterpriseMapper">

    <resultMap type="com.lgyun.system.order.vo.InvoiceEnterpriseVO" id="InvoiceEnterpriseVOMap">
        <result property="enterpriseId" column="enterprise_id"/>
        <result property="payEnterpriseId" column="pay_enterprise_id"/>
        <result property="payMakerId" column="pay_maker_id"/>
        <result property="enterpriseName" column="enterprise_name"/>
        <result property="serviceProviderName" column="service_provider_name"/>
        <result property="worksheetType" column="worksheet_type"/>
        <result property="payToPlatformAmount" column="pay_to_platform_amount"/>
        <result property="makerVoiceUrl" column="maker_voice_url"/>
        <result property="makerTaxUrl" column="maker_tax_url"/>
        <result property="worksheetName" column="worksheet_name"/>
        <result property="worksheetMode" column="worksheet_mode"/>
        <result property="createTime" column="create_time"/>
        <result property="worksheetNo" column="worksheet_no"/>
        <result property="achievementFiles" column="achievement_files"/>
        <result property="checkMoney" column="check_money"/>
        <result property="makerNum" column="maker_num"/>
    </resultMap>

    <resultMap type="com.lgyun.system.order.vo.PayEnterpriseMakersListVO" id="payEnterpriseMakersListVO">
        <result property="id" column="id"/>
        <result property="payEnterpriseId" column="pay_enterprise_id"/>
        <result property="enterpriseName" column="enterprise_name"/>
        <result property="serviceProviderName" column="service_provider_name"/>
        <result property="chargeListUrl" column="charge_list_url"/>
        <result property="enterprisePayReceiptUrls" column="enterprise_pay_receipt_urls"/>
        <result property="worksheetNo" column="worksheet_no"/>
        <result property="acceptPaysheetUrls" column="accept_paysheet_urls"/>
        <result property="makerPayReceiptUrls" column="maker_pay_receipt_urls"/>
        <result property="auditState" column="audit_state"/>
        <result property="createTime" column="create_time"/>
        <result property="payToPlatformAmount" column="pay_to_platform_amount"/>
    </resultMap>

    <resultMap type="com.lgyun.system.order.vo.PayEnterpriseMakerListVO" id="payEnterpriseMakerListVO">
        <result property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="boolRealNameVerify" column="bool_real_name_verify"/>
        <result property="boolSign" column="bool_sign"/>
    </resultMap>


    <resultMap id="EnterpriseLumpSumInvoiceMap" type="com.lgyun.system.order.vo.EnterpriseLumpSumInvoiceVO">
        <result property="payEnterpriseId" column="pay_enterprise_id"/>
        <result property="invoicePrintId" column="invoice_print_id"/>
        <result property="worksheetId" column="worksheet_id"/>
        <result property="enterpriseId" column="enterprise_id"/>
        <result property="serviceProviderId" column="service_provider_id"/>
        <result property="applicationId" column="application_id"/>
        <result property="enterpriseName" column="enterprise_name"/>
        <result property="serviceProviderName" column="service_provider_name"/>
        <result property="chargeListUrl" column="charge_list_url"/>
        <result property="invoiceSerialNo" column="invoice_serial_no"/>
        <result property="companyInvoiceState" column="company_invoice_state"/>
        <result property="serviceProviderName" column="service_provider_name"/>
        <result property="invoicePrintDate" column="invoice_print_date"/>
        <result property="expressSheetNo" column="express_sheet_no"/>
        <result property="expressCompanyName" column="express_company_name"/>
    </resultMap>

    <resultMap id="EnterprisePaymentListMap" type="com.lgyun.system.order.vo.EnterprisePaymentListVO">
        <result property="payEnterpriseId" column="pay_enterprise_id"/>
        <result property="serviceProviderId" column="service_provider_id"/>
        <result property="serviceProviderName" column="service_provider_name"/>
        <result property="chargeListUrl" column="charge_list_url"/>
        <result property="createTime" column="create_time"/>
    </resultMap>

    <resultMap id="EnterpriseSubcontractSummaryMap" type="com.lgyun.system.order.vo.EnterpriseSubcontractInvoiceVO">
        <result property="payEnterpriseId" column="pay_enterprise_id"/>
        <result property="serviceProviderId" column="service_provider_id"/>
        <result property="makerTotalInvoiceId" column="maker_total_invoice_id"/>
        <result property="invoiceSerialNo" column="invoice_serial_no"/>
        <result property="companyInvoiceUrl" column="company_invoice_url"/>
        <result property="makerTaxUrl" column="maker_tax_url"/>
        <result property="companyInvoiceState" column="company_invoice_state"/>
        <result property="serviceProviderName" column="service_provider_name"/>
        <result property="invoicePrintDate" column="invoice_print_date"/>
    </resultMap>

    <resultMap id="EnterpriseSubcontractPortalMap" type="com.lgyun.system.order.vo.EnterpriseSubcontractPortalVO">
        <result property="payEnterpriseId" column="pay_enterprise_id"/>
        <result property="serviceProviderId" column="service_provider_id"/>
        <result property="payMakerId" column="pay_maker_id"/>
        <result property="makerInvoiceId" column="maker_invoice_id"/>
        <result property="makerTaxRecordId" column="maker_tax_record_id"/>
        <result property="voiceSerialNo" column="voice_serial_no"/>
        <result property="makerVoiceUrl" column="maker_voice_url"/>
        <result property="makerTaxUrl" column="maker_tax_url"/>
        <result property="companyInvoiceState" column="company_invoice_state"/>
        <result property="serviceProviderName" column="service_provider_name"/>
        <result property="invoicePrintDate" column="invoice_print_date"/>
    </resultMap>

    <resultMap type="com.lgyun.system.order.vo.PayMakerListVO" id="payMakerListVO">
        <result property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="idcardNo" column="idcard_no"/>
        <result property="makerNetIncome" column="maker_net_income"/>
        <result property="makerTaxFee" column="maker_tax_fee"/>
        <result property="auditFee" column="audit_fee"/>
        <result property="payFee" column="pay_fee"/>
        <result property="totalFee" column="total_fee"/>
        <result property="serviceRate" column="service_rate"/>
    </resultMap>

    <select id="getEnterpriseAll" resultMap="InvoiceEnterpriseVOMap">
        SELECT e.id AS enterprise_id, pe.id AS pay_enterprise_id, pm.id AS pay_maker_id, e.enterprise_name AS enterprise_name FROM diyi_enterprise e
        INNER JOIN diyi_pay_enterprise pe ON e.id = pe.enterprise_id INNER JOIN diyi_pay_maker pm ON pm.pay_enterprise_id = pe.id
        WHERE e.is_deleted = 0 AND pe.is_deleted = 0 AND pm.is_deleted = 0 AND pm.maker_id = #{param1} GROUP BY e.id
    </select>

    <select id="getEnterpriseMakerIdAll" resultMap="InvoiceEnterpriseVOMap">
        SELECT e.id AS enterprise_id,pe.maker_num, pe.id AS pay_enterprise_id, pm.id AS pay_maker_id, e.enterprise_name AS enterprise_name,
        s.service_provider_name AS service_provider_name, w.worksheet_type, pe.pay_to_platform_amount FROM diyi_enterprise e INNER JOIN diyi_pay_enterprise pe
        ON e.id = pe.enterprise_id INNER JOIN diyi_pay_maker pm ON pm.pay_enterprise_id = pe.id INNER JOIN diyi_service_provider s ON pe.service_provider_id = s.id
        LEFT JOIN diyi_worksheet w ON w.id = pe.worksheet_id AND w.is_deleted = 0 WHERE e.is_deleted = 0 AND pe.is_deleted = 0 AND pm.is_deleted = 0 AND
        s.is_deleted = 0 AND pm.maker_id = #{param1} and e.id= #{param2}
    </select>

    <select id="getEnterpriseMakerIdDetail" resultMap="InvoiceEnterpriseVOMap">
        SELECT e.id AS enterprise_id, pe.id AS pay_enterprise_id, pm.id AS pay_maker_id, e.enterprise_name AS enterprise_name,
        s.service_provider_name AS service_provider_name, w.worksheet_type, pe.pay_to_platform_amount, mi.maker_voice_url, mtr.maker_tax_url, w.worksheet_name,
        w.worksheet_mode, w.create_time, w.worksheet_no, wm.achievement_desc, wm.achievement_files, wm.check_money FROM diyi_enterprise e
        INNER JOIN diyi_pay_enterprise pe ON e.id = pe.enterprise_id INNER JOIN diyi_service_provider s ON pe.service_provider_id = s.id
        INNER JOIN diyi_pay_maker pm ON pm.pay_enterprise_id = pe.id LEFT JOIN diyi_worksheet w ON w.id = pe.worksheet_id AND w.is_deleted = 0
        INNER JOIN diyi_maker_invoice mi ON mi.pay_maker_id = pm.id INNER JOIN diyi_maker_tax_record mtr ON mtr.pay_maker_id = pm.id LEFT JOIN diyi_worksheet_maker wm
        ON pe.worksheet_id = wm.worksheet_id AND wm.is_deleted = 0 WHERE e.is_deleted = 0 AND pe.is_deleted = 0 AND s.is_deleted = 0 AND pm.is_deleted = 0 AND
        mi.is_deleted = 0 and mtr.is_deleted = 0 and pm.maker_id = #{param1} and e.id= #{param2} and pm.id=#{param3}
    </select>

    <select id="getPayEnterprises" resultMap="payEnterpriseMakersListVO">
        SELECT t1.id, t2.enterprise_name, t3.service_provider_name, t1.charge_list_url, t4.worksheet_no, t1.create_time, t1.pay_to_platform_amount, t1.audit_state,
        (SELECT group_concat(enterprise_pay_receipt_url) FROM diyi_pay_enterprise_receipt WHERE is_deleted = 0 AND pay_enterprise_id = t1.id) AS enterprise_pay_receipt_urls,
        (SELECT group_concat(accept_paysheet_url) FROM diyi_accept_paysheet WHERE is_deleted = 0 AND pay_enterprise_id = t1.id) AS accept_paysheet_urls FROM diyi_pay_enterprise t1
        INNER JOIN diyi_enterprise t2 ON t1.enterprise_id = t2.id INNER JOIN diyi_service_provider t3 ON t1.service_provider_id = t3.id LEFT JOIN diyi_worksheet t4
        ON t1.worksheet_id = t4.id AND t4.is_deleted = 0 WHERE t1.is_deleted = 0 AND t2.is_deleted = 0 AND t3.is_deleted = 0
        <if test="param1 != null">
            AND t1.enterprise_id = #{param1}
        </if>
        <if test="param2 != null">
            AND t1.service_provider_id = #{param2}
        </if>
        <if test="param3.payEnterpriseMakerId != null">
            AND t1.id = #{param3.payEnterpriseMakerId}
        </if>
        <if test="param3.serviceProviderName != null and param3.serviceProviderName.trim() != ''">
            AND t3.service_provider_name like concat('%', #{param3.serviceProviderName}, '%')
        </if>
        <if test="param3.enterpriseName != null and param3.enterpriseName.trim() != ''">
            AND t2.enterprise_name like concat('%', #{param3.enterpriseName}, '%')
        </if>
        <if test="param3.beginDate != null">
            AND DATEDIFF(t1.create_time, #{param3.beginDate}) <![CDATA[ >= ]]> 0
        </if>
        <if test="param3.endDate != null">
            AND DATEDIFF(t1.create_time, #{param3.endDate}) <![CDATA[ <= ]]> 0
        </if>
    </select>

    <select id="getMakers" resultMap="payEnterpriseMakerListVO">
        SELECT t3.id, t3.name, IF(t3.bank_card_verify_status = 'VERIFYPASS', TRUE, FALSE) AS bool_real_name_verify,
        IF((SELECT COUNT(id) FROM diyi_agreement WHERE is_deleted = 0 AND maker_id = t3.id AND sign_state = 'SIGNED' AND agreement_type = 1) > 0
        AND (SELECT COUNT(id) FROM diyi_agreement WHERE is_deleted = 0 AND maker_id = t3.id AND sign_state = 'SIGNED' AND agreement_type = 9) > 0, TRUE, FALSE) AS bool_sign
        FROM diyi_pay_enterprise t1 INNER JOIN diyi_worksheet_maker t2 ON t1.worksheet_id = t2.worksheet_id INNER JOIN diyi_maker t3 ON t2.maker_id = t3.id
        WHERE t1.is_deleted = 0 AND t2.is_deleted = 0 AND t3.is_deleted = 0 AND t1.id = #{param1}
    </select>

    <select id="findEnterpriseLumpSumInvoice" resultMap="EnterpriseLumpSumInvoiceMap">
        SELECT pe.id AS pay_enterprise_id, pi.id AS invoice_print_id, e.id AS enterprise_id, sp.id AS service_provider_id, ia.id AS application_id, e.enterprise_name,pe.worksheet_id, sp.service_provider_name, pe.charge_list_url, pil.invoice_serial_no, pil.company_invoice_url, pe.company_invoice_state, pe.invoice_print_date, pi.express_sheet_no, pi.express_company_name FROM diyi_PLATFORM_INVOICE_PAY_LIST pipl INNER JOIN diyi_pay_enterprise pe ON pe.id = pipl.pay_enterprise_id INNER JOIN diyi_platform_invoice pi ON pi.id = pipl.invoice_print_id INNER JOIN diyi_platform_invoice_list pil ON pil.invoice_print_id = pi.id INNER JOIN diyi_enterprise e ON e.id = pe.enterprise_id INNER JOIN diyi_service_provider sp ON sp.id = pe.service_provider_id LEFT JOIN diyi_INVOICE_APPLICATION ia ON ia.id = pi.application_id AND ia.is_deleted = 0 and ia.application_state != 'CANCELLED' and ia.application_state !='REJECTED'
         WHERE pipl.is_deleted = 0 AND pe.is_deleted = 0 AND pi.is_deleted = 0 AND pil.is_deleted = 0 AND e.is_deleted = 0 AND sp.is_deleted = 0 and pe.enterprise_id = #{param5}
        <if test="param1 != null and param1 != ''">
            AND pil.invoice_serial_no like concat('%', #{param1}, '%')
        </if>
        <if test="param2 != null and param2 != ''">
            AND sp.service_provider_name like concat('%', #{param2}, '%')
        </if>
        <if test="param3 != null and param3 != ''">
            AND DATEDIFF(pe.create_time, #{param3}) <![CDATA[ >= ]]> 0
        </if>
        <if test="param4 != null and param4 != ''">
            AND DATEDIFF(pe.create_time, #{param4}) <![CDATA[ <= ]]> 0
        </if>
    </select>

    <select id="findPayEnterpriseDetails" resultMap="EnterpriseLumpSumInvoiceMap">
        SELECT pe.id AS pay_enterprise_id, pi.id AS invoice_print_id, e.id AS enterprise_id, sp.id AS service_provider_id, ia.id AS application_id,
        e.enterprise_name, sp.service_provider_name, pe.charge_list_url, pil.invoice_serial_no, pil.company_invoice_url, pe.company_invoice_state,
        pe.invoice_print_date, pe.worksheet_id, pi.express_sheet_no, pi.express_company_name FROM diyi_PLATFORM_INVOICE_PAY_LIST pipl INNER JOIN diyi_pay_enterprise
        pe ON pe.id = pipl.pay_enterprise_id INNER JOIN diyi_platform_invoice pi ON pi.id = pipl.invoice_print_id INNER JOIN diyi_platform_invoice_list pil
        ON pil.invoice_print_id = pi.id INNER JOIN diyi_enterprise e ON e.id = pe.enterprise_id INNER JOIN diyi_service_provider sp ON sp.id = pe.service_provider_id
        LEFT JOIN diyi_INVOICE_APPLICATION ia ON ia.id = pi.application_id AND ia.is_deleted = 0 AND ia.application_state != 'CANCELLED' and ia.application_state !='REJECTED' WHERE pipl.is_deleted = 0
        AND pe.is_deleted = 0 AND pi.is_deleted = 0 AND pil.is_deleted = 0 AND e.is_deleted = 0 AND sp.is_deleted = 0 AND pe.id = #{param1}
    </select>

    <select id="findEnterprisePaymentList" resultMap="EnterprisePaymentListMap">
        SELECT pe.id AS pay_enterprise_id, sp.id AS service_provider_id, sp.service_provider_name, pe.charge_list_url, pe.create_time AS create_time
        FROM diyi_pay_enterprise pe INNER JOIN diyi_service_provider sp ON pe.service_provider_id = sp.id INNER JOIN diyi_platform_invoice_pay_list pl on pl.pay_enterprise_id = pe.id
        where pe.company_invoice_state != 'OPENED' and  pe.enterprise_id = #{param1}
        <if test="param2 != null and param2 != ''">
            AND sp.service_provider_name like concat('%', #{param2}, '%')
        </if>
    </select>

    <select id="findEnterpriseSubcontractSummary" resultMap="EnterpriseSubcontractSummaryMap">
        SELECT pe.id AS pay_enterprise_id, mt.id AS maker_total_invoice_id, sp.id AS service_provider_id, mt.invoice_serial_no, mt.company_invoice_url,
        mt.maker_tax_url, pe.company_invoice_state, sp.service_provider_name, pe.invoice_print_date FROM diyi_pay_enterprise pe INNER JOIN diyi_maker_total_invoice mt
        ON mt.pay_enterprise_id = pe.id INNER JOIN diyi_service_provider sp ON sp.id = pe.service_provider_id
        where pe.is_deleted= 0 and mt.is_deleted = 0 and sp.is_deleted = 0 and pe.enterprise_id = #{param1}
        <if test="param2 != null and param2 != ''">
            AND sp.service_provider_name like concat('%', #{param2}, '%')
        </if>
    </select>

    <select id="findEnterpriseSubcontractPortal" resultMap="EnterpriseSubcontractPortalMap">
        SELECT pe.id AS pay_enterprise_id,sp.id as service_provider_id, pm.id AS pay_maker_id, mi.id AS maker_invoice_id, mtr.id AS maker_tax_record_id,
         mi.voice_serial_no, mi.maker_voice_url, mtr.maker_tax_url, pe.company_invoice_state, sp.service_provider_name, pe.invoice_print_date
         FROM diyi_pay_enterprise pe INNER JOIN diyi_pay_maker pm ON pm.pay_enterprise_id = pe.id INNER JOIN diyi_maker_invoice mi ON mi.pay_maker_id = pm.id
         INNER JOIN diyi_service_provider sp ON pe.service_provider_id = sp.id LEFT JOIN diyi_maker_tax_record mtr ON pm.id = mtr.pay_maker_id AND mtr.is_deleted = 0
         WHERE pe.is_deleted = 0 AND pm.is_deleted = 0 AND mi.is_deleted = 0 AND sp.is_deleted = 0 and pe.enterprise_id = #{param1}
        <if test="param2 != null and param2 != ''">
            AND sp.service_provider_name like concat('%', #{param2}, '%')
        </if>
    </select>


    <select id="findDetailSummary" resultMap="EnterpriseSubcontractSummaryMap">
        SELECT pe.id AS pay_enterprise_id, mt.id AS maker_total_invoice_id, sp.id AS service_provider_id, mt.invoice_serial_no, mt.company_invoice_url,
        mt.maker_tax_url, pe.company_invoice_state, sp.service_provider_name, pe.invoice_print_date FROM diyi_pay_enterprise pe INNER JOIN diyi_maker_total_invoice
        mt ON mt.pay_enterprise_id = pe.id INNER JOIN diyi_service_provider sp ON sp.id = pe.service_provider_id
        where pe.is_deleted= 0 and mt.is_deleted = 0 and sp.is_deleted = 0 and mt.id = #{param1}
    </select>


    <select id="findDetailSubcontractPortal" resultMap="EnterpriseSubcontractPortalMap">
        SELECT pe.id AS pay_enterprise_id,sp.id as service_provider_id, pm.id AS pay_maker_id, mi.id AS maker_invoice_id, mtr.id AS maker_tax_record_id,
        mi.voice_serial_no, mi.maker_voice_url, mtr.maker_tax_url, pe.company_invoice_state, sp.service_provider_name, pe.invoice_print_date
        FROM diyi_pay_enterprise pe INNER JOIN diyi_pay_maker pm ON pm.pay_enterprise_id = pe.id INNER JOIN diyi_maker_invoice mi ON mi.pay_maker_id = pm.id
        INNER JOIN diyi_service_provider sp ON pe.service_provider_id = sp.id LEFT JOIN diyi_maker_tax_record mtr ON pm.id = mtr.pay_maker_id AND mtr.is_deleted = 0
        WHERE pe.is_deleted = 0 AND pm.is_deleted = 0 AND mi.is_deleted = 0 AND sp.is_deleted = 0 and mi.id = #{param1}
    </select>

    <select id="getPayMakerListByPayEnterpriseId" resultMap="payMakerListVO">
        SELECT t2.id, t2.name, t2.idcard_no, t1.maker_net_income, t1.maker_tax_fee, t1.audit_fee, t1.pay_fee, t1.total_fee, t1.service_rate
        FROM diyi_pay_maker t1 LEFT JOIN diyi_maker t2 ON t1.maker_id = t2.id AND t2.is_deleted = 0 WHERE t1.is_deleted = 0
        AND t1.pay_enterprise_id = #{param1}
    </select>

</mapper>
