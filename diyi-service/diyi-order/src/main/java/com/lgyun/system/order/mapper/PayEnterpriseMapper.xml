<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lgyun.system.order.mapper.PayEnterpriseMapper">

    <!-- 可根据自己的需求，是否要使用 -->
    <resultMap type="com.lgyun.system.order.entity.PayEnterpriseEntity" id="enterprisePayMap">
        <result property="id" column="id"/>
        <result property="enterpriseId" column="enterprise_id"/>
        <result property="serviceProviderId" column="service_provider_id"/>
        <result property="chargeListUrl" column="charge_list_url"/>
        <result property="worksheetId" column="worksheet_id"/>
        <result property="payToPlatformAmount" column="pay_to_platform_amount"/>
        <result property="sourcingAmount" column="sourcing_amount"/>
        <result property="serviceRate" column="service_rate"/>
        <result property="totalTaxFee" column="total_tax_fee"/>
        <result property="makerNum" column="maker_num"/>
        <result property="identifyFee" column="identify_fee"/>
        <result property="serviceFee" column="service_fee"/>
        <result property="payMemo" column="pay_memo"/>
        <result property="payState" column="pay_state"/>
        <result property="payConfirmDateTime" column="pay_confirm_date_time"/>
        <result property="confirmDateTime" column="confirm_date_time"/>
        <result property="employeeId" column="employee_id"/>
        <result property="companyInvoiceState" column="company_invoice_state"/>
        <result property="invoicePrintDate" column="invoice_print_date"/>
        <result property="createUser" column="create_user"/>
        <result property="createTime" column="create_time"/>
        <result property="updateUser" column="update_user"/>
        <result property="updateTime" column="update_time"/>
        <result property="status" column="status"/>
        <result property="isDeleted" column="is_deleted"/>
    </resultMap>

    <resultMap type="com.lgyun.system.order.vo.InvoiceEnterpriseVO" id="InvoiceEnterpriseVOMap">
        <result property="enterpriseId" column="enterprise_id"/>
        <result property="payEnterpriseId" column="pay_enterprise_id"/>
        <result property="payMakerId" column="pay_maker_id"/>
        <result property="enterpriseName" column="enterprise_name"/>
        <result property="serviceProviderName" column="service_provider_name"/>
        <result property="worksheetType" column="worksheet_type"/>
        <result property="payToPlatformAmount" column="pay_to_platform_amount"/>
        <result property="makerVoiceUrl" column="maker_voice_url"/>
        <result property="makerTaxUrl" column="maker_tax_url"/>
        <result property="worksheetName" column="worksheet_name"/>
        <result property="worksheetMode" column="worksheet_mode"/>
        <result property="createTime" column="create_time"/>
        <result property="worksheetNo" column="worksheet_no"/>
        <result property="achievementFiles" column="achievement_files"/>
        <result property="checkMoney" column="check_money"/>
        <result property="makerNum" column="maker_num"/>
    </resultMap>

    <resultMap type="com.lgyun.system.order.vo.PayEnterpriseStatisticalVO" id="payEnterpriseStatisticalVO">
        <result property="monthPay" column="month_pay"/>
        <result property="yearPay" column="year_pay"/>
        <result property="allPay" column="all_pay"/>
        <result property="makerNum" column="maker_num"/>
        <result property="serviceProviderNum" column="service_provider_num"/>
    </resultMap>

    <resultMap type="com.lgyun.system.order.vo.PayEnterpriseTotalListVO" id="payEnterpriseTotalListVO">
        <result property="id" column="id"/>
        <result property="enterpriseName" column="enterprise_name"/>
        <result property="serviceProviderName" column="service_provider_name"/>
        <result property="chargeListUrl" column="charge_list_url"/>
        <result property="enterprisePayReceiptUrls" column="enterprise_pay_receipt_urls"/>
        <result property="worksheetNo" column="worksheet_no"/>
        <result property="acceptPaysheetUrls" column="accept_paysheet_urls"/>
        <result property="createTime" column="create_time"/>
        <result property="payToPlatformAmount" column="pay_to_platform_amount"/>
    </resultMap>
    
    <select id="getEnterpriseAll" resultMap="InvoiceEnterpriseVOMap">
        SELECT e.id AS enterprise_id, pe.id AS pay_enterprise_id, pm.id AS pay_maker_id, e.enterprise_name AS enterprise_name FROM diyi_enterprise e
        INNER JOIN diyi_pay_enterprise pe ON e.id = pe.enterprise_id INNER JOIN diyi_pay_maker pm ON pm.pay_enterprise_id = pe.id
        WHERE e.is_deleted = 0 AND pe.is_deleted = 0 AND pm.is_deleted = 0 AND pm.maker_id = #{param1} GROUP BY e.id
    </select>

    <select id="getEnterpriseMakerIdAll" resultMap="InvoiceEnterpriseVOMap">
        SELECT e.id AS enterprise_id,pe.maker_num, pe.id AS pay_enterprise_id, pm.id AS pay_maker_id, e.enterprise_name AS enterprise_name,
        s.service_provider_name AS service_provider_name, w.worksheet_type, pe.pay_to_platform_amount FROM diyi_enterprise e INNER JOIN diyi_pay_enterprise pe
        ON e.id = pe.enterprise_id INNER JOIN diyi_pay_maker pm ON pm.pay_enterprise_id = pe.id INNER JOIN diyi_service_provider s ON pe.service_provider_id = s.id
        LEFT JOIN diyi_worksheet w ON w.id = pe.worksheet_id AND w.is_deleted = 0 WHERE e.is_deleted = 0 AND pe.is_deleted = 0 AND pm.is_deleted = 0 AND
        s.is_deleted = 0 AND pm.maker_id = #{param1} and e.id= #{param2}
    </select>


    <select id="getEnterpriseMakerIdDetail" resultMap="InvoiceEnterpriseVOMap">
        SELECT e.id AS enterprise_id, pe.id AS pay_enterprise_id, pm.id AS pay_maker_id, e.enterprise_name AS enterprise_name,
        s.service_provider_name AS service_provider_name, w.worksheet_type, pe.pay_to_platform_amount, mi.maker_voice_url, mtr.maker_tax_url, w.worksheet_name,
        w.worksheet_mode, w.create_time, w.worksheet_no, wm.achievement_desc, wm.achievement_files, wm.check_money FROM diyi_enterprise e
        INNER JOIN diyi_pay_enterprise pe ON e.id = pe.enterprise_id INNER JOIN diyi_service_provider s ON pe.service_provider_id = s.id
        INNER JOIN diyi_pay_maker pm ON pm.pay_enterprise_id = pe.id LEFT JOIN diyi_worksheet w ON w.id = pe.worksheet_id AND w.is_deleted = 0
        INNER JOIN diyi_maker_invoice mi ON mi.pay_maker_id = pm.id INNER JOIN diyi_maker_tax_record mtr ON mtr.pay_maker_id = pm.id LEFT JOIN diyi_worksheet_maker wm
        ON pe.worksheet_id = wm.worksheet_id AND wm.is_deleted = 0 WHERE e.is_deleted = 0 AND pe.is_deleted = 0 AND s.is_deleted = 0 AND pm.is_deleted = 0 AND
        mi.is_deleted = 0 and mtr.is_deleted = 0 and pm.maker_id = #{param1} and e.id= #{param2} and pm.id=#{param3}
    </select>

    <select id="statistical" resultMap="payEnterpriseStatisticalVO">

    </select>

    <select id="getByDtoEnterprise" resultMap="payEnterpriseTotalListVO">
        SELECT t1.id, t2.enterprise_name, t3.service_provider_name, t1.charge_list_url, t4.worksheet_no, t1.create_time, t1.pay_to_platform_amount,
        (SELECT group_concat(enterprise_pay_receipt_url) FROM diyi_pay_enterprise_receipt WHERE pay_enterprise_id = t1.id) AS enterprise_pay_receipt_urls,
        (SELECT group_concat(accept_paysheet_url) FROM diyi_accept_paysheet WHERE pay_enterprise_id = t1.id) AS accept_paysheet_urls FROM diyi_pay_enterprise t1
        INNER JOIN diyi_enterprise t2 ON t1.enterprise_id = t2.id INNER JOIN diyi_service_provider t3 ON t1.service_provider_id = t3.id LEFT JOIN diyi_worksheet t4
        ON t1.worksheet_id = t4.id WHERE t1.is_deleted = 0 AND t2.is_deleted = 0 AND t3.is_deleted = 0 AND t4.is_deleted = 0 AND t1.enterprise_id = #{param1}
        <if test="param2.payEnterpriseId != null">
            AND t1.id = #{param2.payEnterpriseId}
        </if>
        <if test="param2.serviceProviderName != null and param2.serviceProviderName.trim() != ''">
            AND t3.service_provider_name like concat('%', #{param2.ibname}, '%')
        </if>
        <if test="param2.beginDate != null">
            AND DATEDIFF(t1.create_time, #{param2.beginDate}) <![CDATA[ >= ]]> 0
        </if>
        <if test="param2.endDate != null">
            AND DATEDIFF(t1.create_time, #{param2.endDate}) <![CDATA[ <= ]]> 0
        </if>
    </select>

</mapper>
